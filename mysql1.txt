' MYSQLに接続する。
' ODBC driver(使用しているEXCELが32ビットなので32ビット版)をMYSQLからダウンロードしてインストールし、
' 管理ツールのODBC設定ではなく、C:\Windows\SysWOW64\odbcad32.exeでデータソース設定すること。
' アクセスはRecordsetのコマンドのCopyFromRecordset,Find,AddNew,Delete,Updateで行う。
'
Sub Sample_ADO_MySQL()
    
    Const MYDRIVER = "Driver={MySQL ODBC 5.3 Unicode Driver};"      'ドライバー
    Const MYSERVER = "Server=localhost;"                            'サーバー
    Const MYPORT = "Port=3306;"                                       'ポート
    Const MYDATABASE = "Data Source=mysqldb1;"                         'データベース名
    Const MYCCODE = "STMT=SET NAMES sjis;"                          '文字コード（Excel側）
    Const MYUSER = "UID=nisira;"                                    'ユーザー名
    Const MYPASS = "PWD=gcmimow5;"                                  'パスワード
    Const MYPROVIDE = "MSDASQL;"
 
    Dim cn As New ADODB.Connection
    Dim rs As New ADODB.Recordset
    
    Dim constr As String
    Dim strSQL As String
    Dim i As Long
    Dim j As Long
    Dim strError As String
    Dim Err As ADODB.Error
            
    On Error GoTo err_handler
    
    constr = MYPROVIDER & MYDATABASE
    cn.ConnectionString = constr
    cn.Open
    
    'データ表示
    rs.ActiveConnection = cn
    rs.Source = "sampletable"
    rs.Open
    
    Worksheets(4).Cells.Clear
    Worksheets(4).Range("A2").CopyFromRecordset Data:=rs
    
    
subend:
    If rs.State = adStateOpen Then
        rs.Close
    End If
    Set rs = Nothing
    If cn.State = adStateOpen Then
        cn.Close
    End If
    Set cn = Nothing
    Exit Sub
    
err_handler:
    For Each Err In cn.Errors

        strError = "Error #" & Err.Number & vbCr & _
           "   " & Err.Description & vbCr & _
           "   (Source: " & Err.Source & ")" & vbCr & _
           "   (SQL State: " & Err.SqlState & ")" & vbCr & _
           "   (NativeError: " & Err.NativeError & ")" & vbCr
        If Err.HelpFile = "" Then
           strError = strError & "   No Help file available"
        Else
           strError = strError & _
              "   (HelpFile: " & Err.HelpFile & ")" & vbCr & _
              "   (HelpContext: " & Err.HelpContext & ")" & _
              vbCr & vbCr
        End If

       Debug.Print strError
    Next

    MsgBox "database error"
    GoTo subend
    
End Sub


' アクセスはCommandオブジェクトでSQLを発行して行う(Execute)。
'
Sub Sample_ADO_MySQL_SQL()
    
    Const MYDRIVER = "Driver={MySQL ODBC 5.3 Unicode Driver};"      'ドライバー
    Const MYSERVER = "Server=localhost;"                            'サーバー
    Const MYPORT = "Port=3306;"                                       'ポート
    Const MYDATABASE = "Data Source=mysqldb1;"                         'データベース名
    Const MYCCODE = "STMT=SET NAMES sjis;"                          '文字コード（Excel側）
    Const MYUSER = "UID=nisira;"                                    'ユーザー名
    Const MYPASS = "PWD=gcmimow5;"                                  'パスワード
    Const MYPROVIDE = "MSDASQL;"
 
    Dim cn As New ADODB.Connection
    Dim rs As New ADODB.Recordset
    Dim cd As New ADODB.Command
    
    Dim constr As String
    Dim i As Long
    Dim j As Long
    Dim strError As String
    Dim Err As ADODB.Error
            
    On Error GoTo err_handler
    
    constr = MYDRIVER & MYSERVER & MYPORT & MYDATABASE & MYCCODE & MYUSER & MYPASS
    cn.ConnectionString = constr
    cn.Open
    
    'データ表示
    cd.CommandText = "select * from dbarea;"
    cd.ActiveConnection = cn
    Set rs = cd.Execute
    
    With Worksheets(5)
        .Cells.Clear
        i = 1
        Do Until rs.EOF
            For j = 0 To rs.Fields.Count - 1
                If i = 1 Then .Cells(i, j + 1) = rs.Fields(j).Name
                .Cells(i + 1, j + 1) = rs(j).Value
                .Cells(i + 1, j + 1).Errors(xlNumberAsText).Ignore = True
            Next j
            rs.MoveNext
            i = i + 1
        Loop
    End With
    
    
subend:
    If rs.State = adStateOpen Then
        rs.Close
    End If
    Set rs = Nothing
    If cn.State = adStateOpen Then
        cn.Close
    End If
    Set cn = Nothing
    Set cd = Nothing
    Exit Sub
    
err_handler:
    For Each Err In cn.Errors

        strError = "Error #" & Err.Number & vbCr & _
           "   " & Err.Description & vbCr & _
           "   (Source: " & Err.Source & ")" & vbCr & _
           "   (SQL State: " & Err.SqlState & ")" & vbCr & _
           "   (NativeError: " & Err.NativeError & ")" & vbCr
        If Err.HelpFile = "" Then
           strError = strError & "   No Help file available"
        Else
           strError = strError & _
              "   (HelpFile: " & Err.HelpFile & ")" & vbCr & _
              "   (HelpContext: " & Err.HelpContext & ")" & _
              vbCr & vbCr
        End If

       Debug.Print strError
    Next

    MsgBox "database error"
    GoTo subend
    
End Sub



