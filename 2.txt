'DDSearch
Sub DDSearch()
    Dim DDRange As Range
    Dim ddf As Range
    Dim DDWb As Workbook 'DD
    
    On Error GoTo Err2
    
    Workbooks(BOOKNAME1).Worksheets(1).Activate
    
    'DDファイル名のレンジ作成
    If Range("C17").Value = "" Then
       Set DDRange = Range("C16")
    Else
       Set DDRange = Range(Range("C16"), Range("C16").End(xlDown))
    End If
    
    Debug.Print DDRange.Rows.Count & " : " & DDRange.Columns.Count
    
    For Each ddf In DDRange
        Workbooks(BOOKNAME1).Worksheets(1).Activate
        Set DDWb = Workbooks.Open(Range("C7") & "\" & ddf.Value)
        If Not DDWb Is Nothing Then
            Call SetDDData(Workbooks(BOOKNAME1), DDWb)
        End If
        
        If Not DDWb Is Nothing Then
            DDWb.Close
        End If
    Next
    Exit Sub

Err2:
    Debug.Print "DDSerach() : ERROR=" & Err.Number & ":" & Err.Description
    If Not DDWb Is Nothing Then
        DDWb.Close
    End If
    Resume Next '次の行から継続する
End Sub


'DDファイルを検索してデータをセットする。
'IN:MainWs=本体ブック,DDWb=DDファイルブック
Sub SetDDData(MainWb As Workbook, DDWb As Workbook)
    
    Call SearchDD(MainWb, MainWb.Worksheets("定数パラメータ"), DDWb, DDWb.Worksheets("Controller_Const"), "const")
    Call SearchDD(MainWb, MainWb.Worksheets("テーブル"), DDWb, DDWb.Worksheets("Controller_Table"), "table")

End Sub


'DDファイルの処理(Const)
Sub SearchDD(MainWb As Workbook, MainWs As Worksheet, DDWb As Workbook, DDWs As Worksheet, DDKey As String)
    Dim SymbolsRange As Range 'シンボルのレンジ
    Dim StartSym As Range 'シンボルの開始位置
    Dim SymLen As Integer 'シンボルレンジ行数
    Dim Sym As Range 'シンボル
    
    Dim DDRange As Range
    Dim StartDD As Range
    Dim DDlen As Integer
    
    Dim SymName As String
    Dim HitRange As Range
    Dim DDName As Range
    
    'DDファイルの情報
    Dim DD1 As String
    Dim DD2 As String
    
    
    Debug.Print "SearchDD():" & MainWb.Name & ":" & MainWs.Name & ":" & DDWb.Name & ":" & DDWs.Name & ":" & DDKey
    
    '検索対象のレンジを作成する
    If MainWb.Worksheets(MainWs.Name).Range("B3").Value <> "" Then
    
        MainWb.Activate
        MainWs.Activate
        Set StartSym = MainWb.Worksheets(MainWs.Name).Range("B3").Offset(0, 2) 'シンボルの先頭位置
        SymLen = MainWb.Worksheets(MainWs.Name).UsedRange.Rows.Count
        If SymLen <= 0 Then Exit Sub
        Set SymbolsRange = Range(StartSym, StartSym.Offset(SymLen - 1, 0))
        Debug.Print "SymbolsRange:" & SymbolsRange.Rows.Count & ":" & SymbolsRange.Columns.Count
        
        DDWb.Activate
        DDWs.Activate
        Set StartDD = DDWb.Worksheets(DDWs.Name).Range("A1").Offset(0, 1) 'DDの先頭位置
        DDlen = DDWb.Worksheets(DDWs.Name).UsedRange.Rows.Count
        If DDlen <= 0 Then Exit Sub
        Set DDRange = Range(StartDD, StartDD.Offset(DDlen - 1, 0))
        
        DDRange.Select
        
        Debug.Print "DDRange:" & DDRange.Rows.Count & ":" & DDRange.Columns.Count
        
        MainWb.Activate
        MainWs.Activate
        
        SymbolsRange.Select
        
        For Each Sym In SymbolsRange
            MainWb.Activate
            MainWs.Activate

            If Sym.Value <> "" Then
                Debug.Print "Symbol=" & Sym.Value
                SymName = Sym.Value
                
                DDWb.Activate
                DDWs.Activate
                
                Set HitRange = Nothing
                
                For Each DDName In DDRange
                DDName.Select
                    If DDKey = DDName.Value And SymName = DDName.Offset(0, 1).Value Then
                        Set HitRange = DDName
                        Exit For
                    End If
                Next
        
                If Not HitRange Is Nothing Then
                    'Hit時の処理
                    DD1 = DDWb.Name
                    DD2 = DDName.Offset(0, 3).Value
                    MainWb.Activate
                    MainWs.Activate
                    Sym.Offset(0, 2).Value = DD1
                    Sym.Offset(0, 3).Value = DD2
                
                End If
        
            End If
       
        Next
        
    End If
    
End Sub



